---
import Layout from '~/layouts/LandingLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import { SITE } from 'astrowind:config';
import KpiStrip from '~/components/home/KpiStrip.astro';
import BioMinimal from '~/components/home/BioMinimal.astro';
import * as athlete from '~/content/athlete/maxence-mey.md';
import Calendar from '~/components/widgets/Calendar.astro';
import Results from '~/components/widgets/Results.astro';
import Partners from '~/components/widgets/Partners.astro';
import ContactSection from '~/components/widgets/ContactSection.astro';
import calendarData from '~/content/calendar/2025.yaml';
import type { Race, MetaData } from '~/types';
import heroImageFile from '~/assets/images/hero-maxence.jpg';

// Find next race for SEO metadata
const { upcoming } = calendarData;
const today = new Date();
today.setHours(0, 0, 0, 0);
const futureRaces = upcoming
  .map((race: Omit<Race, 'date'> & { date: string }) => ({ ...race, date: new Date(race.date) }))
  .filter((race: Race) => race.date.getTime() >= today.getTime())
  .sort((a: Race, b: Race) => a.date.getTime() - b.date.getTime());
const next: Race | undefined = futureRaces.length > 0 ? futureRaces[0] : undefined;

const kpis = [
  { label: 'Record Half', value: '3h51' },
  { label: "Podiums", value: "—" },
  { label: "Classement PTO", value: "~270" },
];

const heroImage = {
  src: heroImageFile,
  alt: 'Maxence Mey triathlète',
  width: heroImageFile.width,
  height: heroImageFile.height,
};

const metadata: MetaData = {
  title: 'Maxence Mey – Triathlète professionnel',
  description: 'Résultats, calendrier, partenaires, contact.',
  nextRace: next,
};
---

<Layout metadata={metadata}>
  <Fragment slot="head">
    <meta property="og:title" content="Maxence Mey – Triathlète professionnel" />
    <meta property="og:description" content="Résultats, calendrier, partenaires, contact." />
    <meta property="og:image" content={new URL('og.jpg', SITE.site).href} />
    <meta name="twitter:card" content="summary_large_image" />

    <script type="application/ld+json" is:inline>
      {
        JSON.stringify({
          '@context': 'https://schema.org',
          '@type': 'Person',
          name: 'Maxence Mey',
          jobTitle: 'Professional Triathlete',
          sport: 'Triathlon',
          url: SITE.site,
          sameAs: ['https://instagram.com/maxencemeytri'],
        })
      }
    </script>

    {
      next && (
        <script type="application/ld+json" is:inline>
          {JSON.stringify({
            '@context': 'https://schema.org',
            '@type': 'SportsEvent',
            name: next.race,
            sport: 'Triathlon',
            startDate: next.date,
            location: { '@type': 'Place', name: next.city },
            url: next.link,
          })}
        </script>
      )
    }
  </Fragment>

  <!-- Hero Widget -->
  <Hero
    actions={[
      {
        variant: 'primary',
        text: 'Suivre sur Instagram',
        href: 'https://instagram.com/maxencemeytri',
        target: '_blank',
        icon: 'tabler:brand-instagram',
      },
      { text: 'Contact', href: '#contact' },
    ]}
    image={heroImage}
  >
    <Fragment slot="title"> Maxence Mey </Fragment>

    <Fragment slot="subtitle">
      <span class="block sm:inline">Triathlète professionnel</span>
      <span class="hidden sm:inline"> · </span>
      <span class="block sm:inline">Middle Distance / 70.3</span>
    </Fragment>
  </Hero>

  <!-- Kpi Strip -->
  <KpiStrip kpis={kpis} />

  <!-- BIO MINIMALISTE (remplace l’ancienne section bio) -->
  <BioMinimal data={athlete.frontmatter} />

  <!-- Calendar Widget -->
  <section id="calendrier">
    <Calendar />
  </section>

  <!-- Results Widget -->
  <section id="resultats">
    <Results />
  </section>

  <!-- Partners Widget -->
  <section id="partenaires">
    <Partners />
  </section>

  <!-- Contact Widget -->
  <section id="contact">
    <ContactSection />
  </section>
</Layout>
