---
import { getEntry } from 'astro:content';

import HeroAthlete from '~/components/home/HeroAthlete.astro';
import KpiStrip from '~/components/home/KpiStrip.astro';
import NextRaceCard from '~/components/home/NextRaceCard.astro';
import ResultsTable from '~/components/home/ResultsTable.astro';
import PhotoHighlight from '~/components/home/PhotoHighlight.astro';
import PartnersMarquee from '~/components/home/PartnersMarquee.astro';
import PressTeasers from '~/components/home/PressTeasers.astro';
import ContactCta from '~/components/home/ContactCta.astro';
import Layout from '~/layouts/Layout.astro';

/* Types */
interface ResultModule {
  frontmatter: {
    date: string;
    title: string;
    distance: string;
    rank: number;
    time?: string;
    source?: string[];
  };
}
interface Race {
  race: string;
  date: string;
  distance: string;
  city: string;
  link: string;
}
interface MappedRace extends Race {
  _d: Date;
}

/* Contenus */
import partners from '~/content/partners.json';
import calendar from '~/content/calendar/2025.json';

const athleteEntry = await getEntry('athlete', 'maxence-mey');
if (!athleteEntry) {
  throw new Error("Athlete entry 'maxence-mey' not found!");
}
const athlete = athleteEntry.data;

/* Charger les résultats (Markdown “eager”) */
const resultMods = Object.values(import.meta.glob('/src/content/results/*.md', { eager: true })) as ResultModule[];
const results = resultMods
  .sort((a, b) => new Date(b.frontmatter.date).getTime() - new Date(a.frontmatter.date).getTime())
  .slice(0, 6);

/* Prochaine course : premier upcoming >= today (Europe/Paris) */
const today = new Date();
const next =
  calendar.upcoming
    .map((x: Race): MappedRace => ({ ...x, _d: new Date(x.date) }))
    .filter((x: MappedRace) => x._d >= today)
    .sort((a: MappedRace, b: MappedRace) => a._d.getTime() - b._d.getTime())[0] ?? calendar.upcoming[0];

const kpis = [
  { label: 'Victoires', value: '—' },
  { label: 'Podiums', value: '—' },
  { label: 'Record Half', value: '3h51' },
  { label: 'Classement PTO', value: '~270' },
];

const metadata = {
  title: 'Maxence Mey – Triathlète',
  description:
    'Portfolio officiel de Maxence Mey, triathlète professionnel middle distance. Résultats, calendrier, partenaires, contact.',
};
---

<Layout metadata={metadata}>
  <HeroAthlete
    title={athlete.title}
    role={athlete.role}
    summary={athlete.summary}
    cover={athlete.cover}
    socials={athlete.socials}
  />

  <KpiStrip kpis={kpis} />

  <NextRaceCard race={next} />

  <ResultsTable items={results} />

  <PhotoHighlight src="/assets/highlight.jpg" caption="Crédit : Organisateur / Photographe" />

  <PartnersMarquee items={partners.partners} />

  <PressTeasers />

  <ContactCta instagram={athlete.socials?.instagram} email={athlete.socials?.email} />
</Layout>
